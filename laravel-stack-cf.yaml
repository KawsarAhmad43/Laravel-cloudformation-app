AWSTemplateFormatVersion: '2010-09-09'
Description: Simple Laravel REST API on EC2 with RDS (Updated for Amazon Linux 2023 - Dec 2025)

Parameters:
  InstanceType:
    Type: String
    Default: t2.micro
    Description: EC2 instance type (t2.micro is free-tier eligible)
  LatestAmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: '/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64'
    Description: Latest Amazon Linux 2023 AMI (x86_64)
  GitRepoUrl:
    Type: String
    Default: https://github.com/KawsarAhmad43/Laravel-cloudformation-app.git
    Description: >-
      REPLACE WITH YOUR PUBLIC GITHUB REPO URL 
      (e.g., https://github.com/KawsarAhmad43/Laravel-cloudformation-app.git)
  DBName:
    Type: String
    Default: laraveldb
  DBUser:
    Type: String
    Default: admin
  DBPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: RDS master password (8+ characters, strong recommended)
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: >-
      Name of an existing EC2 KeyPair for SSH access 
      (create one in EC2 console if you don't have it; optional but recommended for debugging)

Resources:
  MyVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      Tags:
        - Key: Name
          Value: LaravelVPC

  MySubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MyVPC
      CidrBlock: 10.0.0.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: LaravelPublicSubnet

  MyInternetGateway:
    Type: AWS::EC2::InternetGateway

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref MyVPC
      InternetGatewayId: !Ref MyInternetGateway

  MyRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref MyVPC

  MyRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref MyRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref MyInternetGateway

  MySubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref MySubnet
      RouteTableId: !Ref MyRouteTable

  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP and SSH
      VpcId: !Ref MyVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0  # RESTRICT TO YOUR IP IN PRODUCTION!

  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow MySQL from EC2
      VpcId: !Ref MyVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref EC2SecurityGroup

  MyDB:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceClass: db.t3.micro
      Engine: mysql
      EngineVersion: '8.0'
      AllocatedStorage: '20'
      DBName: !Ref DBName
      MasterUsername: !Ref DBUser
      MasterUserPassword: !Ref DBPassword
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      PubliclyAccessible: false
      MultiAZ: false

  MyEC2Instance:
    Type: AWS::EC2::Instance
    Metadata:
      AWS::CloudFormation::Init:
        configSets:
          default:
            - install
            - setup
        install:
          packages:
            dnf:
              httpd: []
              php: []
              php-mysqlnd: []
              php-mbstring: []
              php-xml: []
              php-json: []
              php-zip: []
              php-bcmath: []
              php-gd: []
              git: []
              mariadb-connector-c: []  # MySQL client
          commands:
            01_install_composer:
              command: |
                curl -sS https://getcomposer.org/installer | php
                mv composer.phar /usr/local/bin/composer
                chmod +x /usr/local/bin/composer
            02_enable_services:
              command: |
                systemctl enable httpd
        setup:
          commands:
            01_clone_repo:
              command: !Sub |
                rm -rf /var/www/html/simple-rest-api
                git clone ${GitRepoUrl} /var/www/html/simple-rest-api
            02_setup_laravel:
              command: |
                cd /var/www/html/simple-rest-api
                composer install --no-dev --optimize-autoloader
                cp .env.example .env
                php artisan key:generate
                chown -R apache:apache .
                chmod -R 755 storage bootstrap/cache
            03_configure_env:
              command: !Sub |
                cd /var/www/html/simple-rest-api
                sed -i "s/DB_CONNECTION=.*/DB_CONNECTION=mysql/" .env
                sed -i "s/DB_HOST=.*/DB_HOST=${MyDB.Endpoint.Address}/" .env
                sed -i "s/DB_PORT=.*/DB_PORT=3306/" .env
                sed -i "s/DB_DATABASE=.*/DB_DATABASE=${DBName}/" .env
                sed -i "s/DB_USERNAME=.*/DB_USERNAME=${DBUser}/" .env
                sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=${DBPassword}/" .env
            04_migrate:
              command: |
                cd /var/www/html/simple-rest-api
                php artisan migrate --force
            05_apache_vhost:
              command: |
                echo '<VirtualHost *:80>
                  DocumentRoot "/var/www/html/simple-rest-api/public"
                  <Directory "/var/www/html/simple-rest-api/public">
                    AllowOverride All
                    Require all granted
                  </Directory>
                </VirtualHost>' > /etc/httpd/conf.d/laravel.conf
                systemctl restart httpd
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !Ref LatestAmiId
      KeyName: !Ref KeyName
      SecurityGroupIds:
        - !Ref EC2SecurityGroup
      SubnetId: !Ref MySubnet
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          dnf update -y
          dnf install -y aws-cfn-bootstrap
          /opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource MyEC2Instance --configsets default --region ${AWS::Region}
          /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource MyEC2Instance --region ${AWS::Region}
    CreationPolicy:
      ResourceSignal:
        Timeout: PT20M
    DependsOn: MyDB

Outputs:
  WebsiteURL:
    Description: Base URL for your Laravel REST API (append /api/posts to test)
    Value: !Sub http://${MyEC2Instance.PublicIp}
  APIEndpointExample:
    Description: Example endpoint for CRUD testing
    Value: !Sub http://${MyEC2Instance.PublicIp}/api/posts
  EC2PublicIP:
    Description: Public IP of EC2 (for SSH debugging)
    Value: !GetAtt MyEC2Instance.PublicIp
  SSHCommand:
    Description: SSH command example (if you provided a key)
    Value: !Sub ssh -i your-key.pem ec2-user@${MyEC2Instance.PublicIp}